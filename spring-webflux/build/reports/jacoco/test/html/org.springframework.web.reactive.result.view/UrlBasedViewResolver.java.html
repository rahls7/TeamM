<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UrlBasedViewResolver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-webflux</a> &gt; <a href="index.source.html" class="el_package">org.springframework.web.reactive.result.view</a> &gt; <span class="el_source">UrlBasedViewResolver.java</span></div><h1>UrlBasedViewResolver.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2002-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.springframework.web.reactive.result.view;

import java.util.Locale;
import java.util.function.Function;

import reactor.core.publisher.Mono;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.lang.Nullable;
import org.springframework.util.Assert;
import org.springframework.util.PatternMatchUtils;

/**
 * A {@link ViewResolver} that allow direct resolution of symbolic view names
 * to URLs without explicit mapping definition. This is useful if symbolic names
 * match the names of view resources in a straightforward manner (i.e. the
 * symbolic name is the unique part of the resource's filename), without the need
 * for a dedicated mapping to be defined for each view.
 *
 * &lt;p&gt;Supports {@link AbstractUrlBasedView} subclasses like
 * {@link org.springframework.web.reactive.result.view.freemarker.FreeMarkerView}.
 * The view class for all views generated by this resolver can be specified
 * via the &quot;viewClass&quot; property.
 *
 * &lt;p&gt;View names can either be resource URLs themselves, or get augmented by a
 * specified prefix and/or suffix. Exporting an attribute that holds the
 * RequestContext to all views is explicitly supported.
 *
 * &lt;p&gt;Example: prefix=&quot;templates/&quot;, suffix=&quot;.ftl&quot;, viewname=&quot;test&quot; -&gt;
 * &quot;templates/test.ftl&quot;
 *
 * &lt;p&gt;As a special feature, redirect URLs can be specified via the &quot;redirect:&quot;
 * prefix. E.g.: &quot;redirect:myAction&quot; will trigger a redirect to the given
 * URL, rather than resolution as standard view name. This is typically used
 * for redirecting to a controller URL after finishing a form workflow.
 *
 * &lt;p&gt;Note: This class does not support localized resolution, i.e. resolving
 * a symbolic view name to different resources depending on the current locale.
 *
 * @author Rossen Stoyanchev
 * @author Sebastien Deleuze
 * @author Juergen Hoeller
 * @since 5.0
 */
<span class="fc" id="L64">public class UrlBasedViewResolver extends ViewResolverSupport</span>
		implements ViewResolver, ApplicationContextAware, InitializingBean {

	/**
	 * Prefix for special view names that specify a redirect URL (usually
	 * to a controller after a form has been submitted and processed).
	 * Such view names will not be resolved in the configured default
	 * way but rather be treated as special shortcut.
	 */
	public static final String REDIRECT_URL_PREFIX = &quot;redirect:&quot;;


	@Nullable
	private Class&lt;?&gt; viewClass;

<span class="fc" id="L79">	private String prefix = &quot;&quot;;</span>

<span class="fc" id="L81">	private String suffix = &quot;&quot;;</span>

	@Nullable
	private String[] viewNames;

<span class="fc" id="L86">	private Function&lt;String, RedirectView&gt; redirectViewProvider = RedirectView::new;</span>

	@Nullable
	private String requestContextAttribute;

	@Nullable
	private ApplicationContext applicationContext;


	/**
	 * Set the view class to instantiate through {@link #createView(String)}.
	 * @param viewClass a class that is assignable to the required view class
	 * which by default is AbstractUrlBasedView
	 */
	public void setViewClass(@Nullable Class&lt;?&gt; viewClass) {
<span class="pc bpc" id="L101" title="2 of 4 branches missed.">		if (viewClass != null &amp;&amp; !requiredViewClass().isAssignableFrom(viewClass)) {</span>
<span class="nc" id="L102">			String name = viewClass.getName();</span>
<span class="nc" id="L103">			throw new IllegalArgumentException(&quot;Given view class [&quot; + name + &quot;] &quot; +</span>
<span class="nc" id="L104">					&quot;is not of type [&quot; + requiredViewClass().getName() + &quot;]&quot;);</span>
		}
<span class="fc" id="L106">		this.viewClass = viewClass;</span>
<span class="fc" id="L107">	}</span>

	/**
	 * Return the view class to be used to create views.
	 */
	@Nullable
	protected Class&lt;?&gt; getViewClass() {
<span class="fc" id="L114">		return this.viewClass;</span>
	}

	/**
	 * Return the required type of view for this resolver.
	 * This implementation returns {@link AbstractUrlBasedView}.
	 * @see AbstractUrlBasedView
	 */
	protected Class&lt;?&gt; requiredViewClass() {
<span class="fc" id="L123">		return AbstractUrlBasedView.class;</span>
	}

	/**
	 * Set the prefix that gets prepended to view names when building a URL.
	 */
	public void setPrefix(@Nullable String prefix) {
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">		this.prefix = (prefix != null ? prefix : &quot;&quot;);</span>
<span class="fc" id="L131">	}</span>

	/**
	 * Return the prefix that gets prepended to view names when building a URL.
	 */
	protected String getPrefix() {
<span class="fc" id="L137">		return this.prefix;</span>
	}

	/**
	 * Set the suffix that gets appended to view names when building a URL.
	 */
	public void setSuffix(@Nullable String suffix) {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">		this.suffix = (suffix != null ? suffix : &quot;&quot;);</span>
<span class="fc" id="L145">	}</span>

	/**
	 * Return the suffix that gets appended to view names when building a URL.
	 */
	protected String getSuffix() {
<span class="fc" id="L151">		return this.suffix;</span>
	}

	/**
	 * Set the view names (or name patterns) that can be handled by this
	 * {@link ViewResolver}. View names can contain simple wildcards such that
	 * 'my*', '*Report' and '*Repo*' will all match the view name 'myReport'.
	 * @see #canHandle
	 */
	public void setViewNames(@Nullable String... viewNames) {
<span class="fc" id="L161">		this.viewNames = viewNames;</span>
<span class="fc" id="L162">	}</span>

	/**
	 * Return the view names (or name patterns) that can be handled by this
	 * {@link ViewResolver}.
	 */
	@Nullable
	protected String[] getViewNames() {
<span class="fc" id="L170">		return this.viewNames;</span>
	}

	/**
	 * URL based {@link RedirectView} provider which can be used to provide, for example,
	 * redirect views with a custom default status code.
	 */
	public void setRedirectViewProvider(Function&lt;String, RedirectView&gt; redirectViewProvider) {
<span class="fc" id="L178">		this.redirectViewProvider = redirectViewProvider;</span>
<span class="fc" id="L179">	}</span>

	/**
	 * Set the name of the {@link RequestContext} attribute for all views.
	 * @param requestContextAttribute name of the RequestContext attribute
	 * @see AbstractView#setRequestContextAttribute
	 */
	public void setRequestContextAttribute(@Nullable String requestContextAttribute) {
<span class="nc" id="L187">		this.requestContextAttribute = requestContextAttribute;</span>
<span class="nc" id="L188">	}</span>

	/**
	 * Return the name of the @link RequestContext} attribute for all views, if any.
	 */
	@Nullable
	protected String getRequestContextAttribute() {
<span class="fc" id="L195">		return this.requestContextAttribute;</span>
	}

	/**
	 * Accept the containing {@code ApplicationContext}, if any.
	 * &lt;p&gt;To be used for the initialization of newly created {@link View} instances,
	 * applying lifecycle callbacks and providing access to the containing environment.
	 * @see #setViewClass
	 * @see #createView
	 * @see #applyLifecycleMethods
	 */
	@Override
	public void setApplicationContext(@Nullable ApplicationContext applicationContext) {
<span class="fc" id="L208">		this.applicationContext = applicationContext;</span>
<span class="fc" id="L209">	}</span>

	/**
	 * Return the containing {@code ApplicationContext}, if any.
	 * @see #setApplicationContext
	 */
	@Nullable
	public ApplicationContext getApplicationContext() {
<span class="fc" id="L217">		return this.applicationContext;</span>
	}


	@Override
	public void afterPropertiesSet() throws Exception {
<span class="nc bnc" id="L223" title="All 2 branches missed.">		if (getViewClass() == null) {</span>
<span class="nc" id="L224">			throw new IllegalArgumentException(&quot;Property 'viewClass' is required&quot;);</span>
		}
<span class="nc" id="L226">	}</span>


	@Override
	public Mono&lt;View&gt; resolveViewName(String viewName, Locale locale) {
<span class="fc bfc" id="L231" title="All 2 branches covered.">		if (!canHandle(viewName, locale)) {</span>
<span class="fc" id="L232">			return Mono.empty();</span>
		}

		AbstractUrlBasedView urlBasedView;
<span class="fc bfc" id="L236" title="All 2 branches covered.">		if (viewName.startsWith(REDIRECT_URL_PREFIX)) {</span>
<span class="fc" id="L237">			String redirectUrl = viewName.substring(REDIRECT_URL_PREFIX.length());</span>
<span class="fc" id="L238">			urlBasedView = this.redirectViewProvider.apply(redirectUrl);</span>
<span class="fc" id="L239">		}</span>
		else {
<span class="fc" id="L241">			urlBasedView = createView(viewName);</span>
		}

<span class="fc" id="L244">		View view = applyLifecycleMethods(viewName, urlBasedView);</span>
		try {
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">			return (urlBasedView.checkResourceExists(locale) ? Mono.just(view) : Mono.empty());</span>
		}
<span class="nc" id="L248">		catch (Exception ex) {</span>
<span class="nc" id="L249">			return Mono.error(ex);</span>
		}
	}

	/**
	 * Indicates whether or not this {@link ViewResolver} can handle the supplied
	 * view name. If not, an empty result is returned. The default implementation
	 * checks against the configured {@link #setViewNames view names}.
	 * @param viewName the name of the view to retrieve
	 * @param locale the Locale to retrieve the view for
	 * @return whether this resolver applies to the specified view
	 * @see org.springframework.util.PatternMatchUtils#simpleMatch(String, String)
	 */
	protected boolean canHandle(String viewName, Locale locale) {
<span class="fc" id="L263">		String[] viewNames = getViewNames();</span>
<span class="fc bfc" id="L264" title="All 4 branches covered.">		return (viewNames == null || PatternMatchUtils.simpleMatch(viewNames, viewName));</span>
	}

	/**
	 * Creates a new View instance of the specified view class and configures it.
	 * Does &lt;i&gt;not&lt;/i&gt; perform any lookup for pre-defined View instances.
	 * &lt;p&gt;Spring lifecycle methods as defined by the bean container do not have to
	 * be called here: They will be automatically applied afterwards, provided
	 * that an {@link #setApplicationContext ApplicationContext} is available.
	 * @param viewName the name of the view to build
	 * @return the View instance
	 * @see #getViewClass()
	 * @see #applyLifecycleMethods
	 */
	protected AbstractUrlBasedView createView(String viewName) {
<span class="fc" id="L279">		Class&lt;?&gt; viewClass = getViewClass();</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">		Assert.state(viewClass != null, &quot;No view class&quot;);</span>

<span class="fc" id="L282">		AbstractUrlBasedView view = (AbstractUrlBasedView) BeanUtils.instantiateClass(viewClass);</span>
<span class="fc" id="L283">		view.setSupportedMediaTypes(getSupportedMediaTypes());</span>
<span class="fc" id="L284">		view.setRequestContextAttribute(getRequestContextAttribute());</span>
<span class="fc" id="L285">		view.setDefaultCharset(getDefaultCharset());</span>
<span class="fc" id="L286">		view.setUrl(getPrefix() + viewName + getSuffix());</span>

<span class="fc" id="L288">		return view;</span>
	}

	/**
	 * Apply the containing {@link ApplicationContext}'s lifecycle methods
	 * to the given {@link View} instance, if such a context is available.
	 * @param viewName the name of the view
	 * @param view the freshly created View instance, pre-configured with
	 * {@link AbstractUrlBasedView}'s properties
	 * @return the {@link View} instance to use (either the original one
	 * or a decorated variant)
	 * @see #getApplicationContext()
	 * @see ApplicationContext#getAutowireCapableBeanFactory()
	 * @see org.springframework.beans.factory.config.AutowireCapableBeanFactory#initializeBean
	 */
	protected View applyLifecycleMethods(String viewName, AbstractUrlBasedView view) {
<span class="fc" id="L304">		ApplicationContext context = getApplicationContext();</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">		if (context != null) {</span>
<span class="fc" id="L306">			Object initialized = context.getAutowireCapableBeanFactory().initializeBean(view, viewName);</span>
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">			if (initialized instanceof View) {</span>
<span class="fc" id="L308">				return (View) initialized;</span>
			}
		}
<span class="nc" id="L311">		return view;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>