<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Jackson2ObjectMapperBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-web</a> &gt; <a href="index.source.html" class="el_package">org.springframework.http.converter.json</a> &gt; <span class="el_source">Jackson2ObjectMapperBuilder.java</span></div><h1>Jackson2ObjectMapperBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2002-2019 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package org.springframework.http.converter.json;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.TimeZone;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.JsonFilter;
import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.PropertyAccessor;
import com.fasterxml.jackson.core.JsonFactory;
import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.databind.AnnotationIntrospector;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.JsonDeserializer;
import com.fasterxml.jackson.databind.JsonSerializer;
import com.fasterxml.jackson.databind.KeyDeserializer;
import com.fasterxml.jackson.databind.MapperFeature;
import com.fasterxml.jackson.databind.Module;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.PropertyNamingStrategy;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.fasterxml.jackson.databind.cfg.HandlerInstantiator;
import com.fasterxml.jackson.databind.jsontype.TypeResolverBuilder;
import com.fasterxml.jackson.databind.module.SimpleModule;
import com.fasterxml.jackson.databind.ser.FilterProvider;
import com.fasterxml.jackson.dataformat.cbor.CBORFactory;
import com.fasterxml.jackson.dataformat.smile.SmileFactory;
import com.fasterxml.jackson.dataformat.xml.JacksonXmlModule;
import com.fasterxml.jackson.dataformat.xml.XmlFactory;
import com.fasterxml.jackson.dataformat.xml.XmlMapper;
import org.apache.commons.logging.Log;

import org.springframework.beans.BeanUtils;
import org.springframework.beans.FatalBeanException;
import org.springframework.context.ApplicationContext;
import org.springframework.core.KotlinDetector;
import org.springframework.http.HttpLogging;
import org.springframework.lang.Nullable;
import org.springframework.util.Assert;
import org.springframework.util.ClassUtils;
import org.springframework.util.StringUtils;
import org.springframework.util.xml.StaxUtils;

/**
 * A builder used to create {@link ObjectMapper} instances with a fluent API.
 *
 * &lt;p&gt;It customizes Jackson's default properties with the following ones:
 * &lt;ul&gt;
 * &lt;li&gt;{@link MapperFeature#DEFAULT_VIEW_INCLUSION} is disabled&lt;/li&gt;
 * &lt;li&gt;{@link DeserializationFeature#FAIL_ON_UNKNOWN_PROPERTIES} is disabled&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;It also automatically registers the following well-known modules if they are
 * detected on the classpath:
 * &lt;ul&gt;
 * &lt;li&gt;&lt;a href=&quot;https://github.com/FasterXML/jackson-datatype-jdk8&quot;&gt;jackson-datatype-jdk8&lt;/a&gt;:
 * support for other Java 8 types like {@link java.util.Optional}&lt;/li&gt;
 * &lt;li&gt;&lt;a href=&quot;https://github.com/FasterXML/jackson-datatype-jsr310&quot;&gt;jackson-datatype-jsr310&lt;/a&gt;:
 * support for Java 8 Date &amp; Time API types&lt;/li&gt;
 * &lt;li&gt;&lt;a href=&quot;https://github.com/FasterXML/jackson-datatype-joda&quot;&gt;jackson-datatype-joda&lt;/a&gt;:
 * support for Joda-Time types&lt;/li&gt;
 * &lt;li&gt;&lt;a href=&quot;https://github.com/FasterXML/jackson-module-kotlin&quot;&gt;jackson-module-kotlin&lt;/a&gt;:
 * support for Kotlin classes and data classes&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Compatible with Jackson 2.6 and higher, as of Spring 4.3.
 *
 * @author Sebastien Deleuze
 * @author Juergen Hoeller
 * @author Tadaya Tsuyukubo
 * @author Eddú Meléndez
 * @since 4.1.1
 * @see #build()
 * @see #configure(ObjectMapper)
 * @see Jackson2ObjectMapperFactoryBean
 */
<span class="fc" id="L101">public class Jackson2ObjectMapperBuilder {</span>

<span class="fc" id="L103">	private static volatile boolean kotlinWarningLogged = false;</span>

<span class="fc" id="L105">	private final Log logger = HttpLogging.forLogName(getClass());</span>

<span class="fc" id="L107">	private final Map&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt; mixIns = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L109">	private final Map&lt;Class&lt;?&gt;, JsonSerializer&lt;?&gt;&gt; serializers = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L111">	private final Map&lt;Class&lt;?&gt;, JsonDeserializer&lt;?&gt;&gt; deserializers = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L113">	private final Map&lt;PropertyAccessor, JsonAutoDetect.Visibility&gt; visibilities = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L115">	private final Map&lt;Object, Boolean&gt; features = new LinkedHashMap&lt;&gt;();</span>

<span class="fc" id="L117">	private boolean createXmlMapper = false;</span>

	@Nullable
	private JsonFactory factory;

	@Nullable
	private DateFormat dateFormat;

	@Nullable
	private Locale locale;

	@Nullable
	private TimeZone timeZone;

	@Nullable
	private AnnotationIntrospector annotationIntrospector;

	@Nullable
	private PropertyNamingStrategy propertyNamingStrategy;

	@Nullable
	private TypeResolverBuilder&lt;?&gt; defaultTyping;

	@Nullable
	private JsonInclude.Include serializationInclusion;

	@Nullable
	private FilterProvider filters;

	@Nullable
	private List&lt;Module&gt; modules;

	@Nullable
	private Class&lt;? extends Module&gt;[] moduleClasses;

<span class="fc" id="L152">	private boolean findModulesViaServiceLoader = false;</span>

<span class="fc" id="L154">	private boolean findWellKnownModules = true;</span>

<span class="fc" id="L156">	private ClassLoader moduleClassLoader = getClass().getClassLoader();</span>

	@Nullable
	private HandlerInstantiator handlerInstantiator;

	@Nullable
	private ApplicationContext applicationContext;

	@Nullable
	private Boolean defaultUseWrapper;


	/**
	 * If set to {@code true}, an {@link XmlMapper} will be created using its
	 * default constructor. This is only applicable to {@link #build()} calls,
	 * not to {@link #configure} calls.
	 */
	public Jackson2ObjectMapperBuilder createXmlMapper(boolean createXmlMapper) {
<span class="fc" id="L174">		this.createXmlMapper = createXmlMapper;</span>
<span class="fc" id="L175">		return this;</span>
	}

	/**
	 * Define the {@link JsonFactory} to be used to create the {@link ObjectMapper}
	 * instance.
	 * @since 5.0
	 */
	public Jackson2ObjectMapperBuilder factory(JsonFactory factory) {
<span class="fc" id="L184">		this.factory = factory;</span>
<span class="fc" id="L185">		return this;</span>
	}

	/**
	 * Define the format for date/time with the given {@link DateFormat}.
	 * &lt;p&gt;Note: Setting this property makes the exposed {@link ObjectMapper}
	 * non-thread-safe, according to Jackson's thread safety rules.
	 * @see #simpleDateFormat(String)
	 */
	public Jackson2ObjectMapperBuilder dateFormat(DateFormat dateFormat) {
<span class="fc" id="L195">		this.dateFormat = dateFormat;</span>
<span class="fc" id="L196">		return this;</span>
	}

	/**
	 * Define the date/time format with a {@link SimpleDateFormat}.
	 * &lt;p&gt;Note: Setting this property makes the exposed {@link ObjectMapper}
	 * non-thread-safe, according to Jackson's thread safety rules.
	 * @see #dateFormat(DateFormat)
	 */
	public Jackson2ObjectMapperBuilder simpleDateFormat(String format) {
<span class="fc" id="L206">		this.dateFormat = new SimpleDateFormat(format);</span>
<span class="fc" id="L207">		return this;</span>
	}

	/**
	 * Override the default {@link Locale} to use for formatting.
	 * Default value used is {@link Locale#getDefault()}.
	 * @since 4.1.5
	 */
	public Jackson2ObjectMapperBuilder locale(Locale locale) {
<span class="fc" id="L216">		this.locale = locale;</span>
<span class="fc" id="L217">		return this;</span>
	}

	/**
	 * Override the default {@link Locale} to use for formatting.
	 * Default value used is {@link Locale#getDefault()}.
	 * @param localeString the locale ID as a String representation
	 * @since 4.1.5
	 */
	public Jackson2ObjectMapperBuilder locale(String localeString) {
<span class="nc" id="L227">		this.locale = StringUtils.parseLocale(localeString);</span>
<span class="nc" id="L228">		return this;</span>
	}

	/**
	 * Override the default {@link TimeZone} to use for formatting.
	 * Default value used is UTC (NOT local timezone).
	 * @since 4.1.5
	 */
	public Jackson2ObjectMapperBuilder timeZone(TimeZone timeZone) {
<span class="fc" id="L237">		this.timeZone = timeZone;</span>
<span class="fc" id="L238">		return this;</span>
	}

	/**
	 * Override the default {@link TimeZone} to use for formatting.
	 * Default value used is UTC (NOT local timezone).
	 * @param timeZoneString the zone ID as a String representation
	 * @since 4.1.5
	 */
	public Jackson2ObjectMapperBuilder timeZone(String timeZoneString) {
<span class="fc" id="L248">		this.timeZone = StringUtils.parseTimeZoneString(timeZoneString);</span>
<span class="fc" id="L249">		return this;</span>
	}

	/**
	 * Set an {@link AnnotationIntrospector} for both serialization and deserialization.
	 */
	public Jackson2ObjectMapperBuilder annotationIntrospector(AnnotationIntrospector annotationIntrospector) {
<span class="fc" id="L256">		this.annotationIntrospector = annotationIntrospector;</span>
<span class="fc" id="L257">		return this;</span>
	}

	/**
	 * Specify a {@link com.fasterxml.jackson.databind.PropertyNamingStrategy} to
	 * configure the {@link ObjectMapper} with.
	 */
	public Jackson2ObjectMapperBuilder propertyNamingStrategy(PropertyNamingStrategy propertyNamingStrategy) {
<span class="fc" id="L265">		this.propertyNamingStrategy = propertyNamingStrategy;</span>
<span class="fc" id="L266">		return this;</span>
	}

	/**
	 * Specify a {@link TypeResolverBuilder} to use for Jackson's default typing.
	 * @since 4.2.2
	 */
	public Jackson2ObjectMapperBuilder defaultTyping(TypeResolverBuilder&lt;?&gt; typeResolverBuilder) {
<span class="nc" id="L274">		this.defaultTyping = typeResolverBuilder;</span>
<span class="nc" id="L275">		return this;</span>
	}

	/**
	 * Set a custom inclusion strategy for serialization.
	 * @see com.fasterxml.jackson.annotation.JsonInclude.Include
	 */
	public Jackson2ObjectMapperBuilder serializationInclusion(JsonInclude.Include serializationInclusion) {
<span class="fc" id="L283">		this.serializationInclusion = serializationInclusion;</span>
<span class="fc" id="L284">		return this;</span>
	}

	/**
	 * Set the global filters to use in order to support {@link JsonFilter @JsonFilter} annotated POJO.
	 * @since 4.2
	 * @see MappingJacksonValue#setFilters(FilterProvider)
	 */
	public Jackson2ObjectMapperBuilder filters(FilterProvider filters) {
<span class="fc" id="L293">		this.filters = filters;</span>
<span class="fc" id="L294">		return this;</span>
	}

	/**
	 * Add mix-in annotations to use for augmenting specified class or interface.
	 * @param target class (or interface) whose annotations to effectively override
	 * @param mixinSource class (or interface) whose annotations are to be &quot;added&quot;
	 * to target's annotations as value
	 * @since 4.1.2
	 * @see com.fasterxml.jackson.databind.ObjectMapper#addMixInAnnotations(Class, Class)
	 */
	public Jackson2ObjectMapperBuilder mixIn(Class&lt;?&gt; target, Class&lt;?&gt; mixinSource) {
<span class="fc" id="L306">		this.mixIns.put(target, mixinSource);</span>
<span class="fc" id="L307">		return this;</span>
	}

	/**
	 * Add mix-in annotations to use for augmenting specified class or interface.
	 * @param mixIns a Map of entries with target classes (or interface) whose annotations
	 * to effectively override as key and mix-in classes (or interface) whose
	 * annotations are to be &quot;added&quot; to target's annotations as value.
	 * @since 4.1.2
	 * @see com.fasterxml.jackson.databind.ObjectMapper#addMixInAnnotations(Class, Class)
	 */
	public Jackson2ObjectMapperBuilder mixIns(Map&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt; mixIns) {
<span class="fc" id="L319">		this.mixIns.putAll(mixIns);</span>
<span class="fc" id="L320">		return this;</span>
	}

	/**
	 * Configure custom serializers. Each serializer is registered for the type
	 * returned by {@link JsonSerializer#handledType()}, which must not be {@code null}.
	 * @see #serializersByType(Map)
	 */
	public Jackson2ObjectMapperBuilder serializers(JsonSerializer&lt;?&gt;... serializers) {
<span class="fc bfc" id="L329" title="All 2 branches covered.">		for (JsonSerializer&lt;?&gt; serializer : serializers) {</span>
<span class="fc" id="L330">			Class&lt;?&gt; handledType = serializer.handledType();</span>
<span class="pc bpc" id="L331" title="2 of 4 branches missed.">			if (handledType == null || handledType == Object.class) {</span>
<span class="nc" id="L332">				throw new IllegalArgumentException(&quot;Unknown handled type in &quot; + serializer.getClass().getName());</span>
			}
<span class="fc" id="L334">			this.serializers.put(serializer.handledType(), serializer);</span>
		}
<span class="fc" id="L336">		return this;</span>
	}

	/**
	 * Configure a custom serializer for the given type.
	 * @since 4.1.2
	 * @see #serializers(JsonSerializer...)
	 */
	public Jackson2ObjectMapperBuilder serializerByType(Class&lt;?&gt; type, JsonSerializer&lt;?&gt; serializer) {
<span class="fc" id="L345">		this.serializers.put(type, serializer);</span>
<span class="fc" id="L346">		return this;</span>
	}

	/**
	 * Configure custom serializers for the given types.
	 * @see #serializers(JsonSerializer...)
	 */
	public Jackson2ObjectMapperBuilder serializersByType(Map&lt;Class&lt;?&gt;, JsonSerializer&lt;?&gt;&gt; serializers) {
<span class="fc" id="L354">		this.serializers.putAll(serializers);</span>
<span class="fc" id="L355">		return this;</span>
	}

	/**
	 * Configure custom deserializers. Each deserializer is registered for the type
	 * returned by {@link JsonDeserializer#handledType()}, which must not be {@code null}.
	 * @since 4.3
	 * @see #deserializersByType(Map)
	 */
	public Jackson2ObjectMapperBuilder deserializers(JsonDeserializer&lt;?&gt;... deserializers) {
<span class="nc bnc" id="L365" title="All 2 branches missed.">		for (JsonDeserializer&lt;?&gt; deserializer : deserializers) {</span>
<span class="nc" id="L366">			Class&lt;?&gt; handledType = deserializer.handledType();</span>
<span class="nc bnc" id="L367" title="All 4 branches missed.">			if (handledType == null || handledType == Object.class) {</span>
<span class="nc" id="L368">				throw new IllegalArgumentException(&quot;Unknown handled type in &quot; + deserializer.getClass().getName());</span>
			}
<span class="nc" id="L370">			this.deserializers.put(deserializer.handledType(), deserializer);</span>
		}
<span class="nc" id="L372">		return this;</span>
	}

	/**
	 * Configure a custom deserializer for the given type.
	 * @since 4.1.2
	 */
	public Jackson2ObjectMapperBuilder deserializerByType(Class&lt;?&gt; type, JsonDeserializer&lt;?&gt; deserializer) {
<span class="fc" id="L380">		this.deserializers.put(type, deserializer);</span>
<span class="fc" id="L381">		return this;</span>
	}

	/**
	 * Configure custom deserializers for the given types.
	 */
	public Jackson2ObjectMapperBuilder deserializersByType(Map&lt;Class&lt;?&gt;, JsonDeserializer&lt;?&gt;&gt; deserializers) {
<span class="fc" id="L388">		this.deserializers.putAll(deserializers);</span>
<span class="fc" id="L389">		return this;</span>
	}

	/**
	 * Shortcut for {@link MapperFeature#AUTO_DETECT_FIELDS} option.
	 */
	public Jackson2ObjectMapperBuilder autoDetectFields(boolean autoDetectFields) {
<span class="fc" id="L396">		this.features.put(MapperFeature.AUTO_DETECT_FIELDS, autoDetectFields);</span>
<span class="fc" id="L397">		return this;</span>
	}

	/**
	 * Shortcut for {@link MapperFeature#AUTO_DETECT_SETTERS}/
	 * {@link MapperFeature#AUTO_DETECT_GETTERS}/{@link MapperFeature#AUTO_DETECT_IS_GETTERS}
	 * options.
	 */
	public Jackson2ObjectMapperBuilder autoDetectGettersSetters(boolean autoDetectGettersSetters) {
<span class="fc" id="L406">		this.features.put(MapperFeature.AUTO_DETECT_GETTERS, autoDetectGettersSetters);</span>
<span class="fc" id="L407">		this.features.put(MapperFeature.AUTO_DETECT_SETTERS, autoDetectGettersSetters);</span>
<span class="fc" id="L408">		this.features.put(MapperFeature.AUTO_DETECT_IS_GETTERS, autoDetectGettersSetters);</span>
<span class="fc" id="L409">		return this;</span>
	}

	/**
	 * Shortcut for {@link MapperFeature#DEFAULT_VIEW_INCLUSION} option.
	 */
	public Jackson2ObjectMapperBuilder defaultViewInclusion(boolean defaultViewInclusion) {
<span class="fc" id="L416">		this.features.put(MapperFeature.DEFAULT_VIEW_INCLUSION, defaultViewInclusion);</span>
<span class="fc" id="L417">		return this;</span>
	}

	/**
	 * Shortcut for {@link DeserializationFeature#FAIL_ON_UNKNOWN_PROPERTIES} option.
	 */
	public Jackson2ObjectMapperBuilder failOnUnknownProperties(boolean failOnUnknownProperties) {
<span class="fc" id="L424">		this.features.put(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, failOnUnknownProperties);</span>
<span class="fc" id="L425">		return this;</span>
	}

	/**
	 * Shortcut for {@link SerializationFeature#FAIL_ON_EMPTY_BEANS} option.
	 */
	public Jackson2ObjectMapperBuilder failOnEmptyBeans(boolean failOnEmptyBeans) {
<span class="fc" id="L432">		this.features.put(SerializationFeature.FAIL_ON_EMPTY_BEANS, failOnEmptyBeans);</span>
<span class="fc" id="L433">		return this;</span>
	}

	/**
	 * Shortcut for {@link SerializationFeature#INDENT_OUTPUT} option.
	 */
	public Jackson2ObjectMapperBuilder indentOutput(boolean indentOutput) {
<span class="fc" id="L440">		this.features.put(SerializationFeature.INDENT_OUTPUT, indentOutput);</span>
<span class="fc" id="L441">		return this;</span>
	}

	/**
	 * Define if a wrapper will be used for indexed (List, array) properties or not by
	 * default (only applies to {@link XmlMapper}).
	 * @since 4.3
	 */
	public Jackson2ObjectMapperBuilder defaultUseWrapper(boolean defaultUseWrapper) {
<span class="fc" id="L450">		this.defaultUseWrapper = defaultUseWrapper;</span>
<span class="fc" id="L451">		return this;</span>
	}

	/**
	 * Specify visibility to limit what kind of properties are auto-detected.
	 * @since 5.1
	 * @see com.fasterxml.jackson.annotation.PropertyAccessor
	 * @see com.fasterxml.jackson.annotation.JsonAutoDetect.Visibility
	 */
	public Jackson2ObjectMapperBuilder visibility(PropertyAccessor accessor, JsonAutoDetect.Visibility visibility) {
<span class="fc" id="L461">		this.visibilities.put(accessor, visibility);</span>
<span class="fc" id="L462">		return this;</span>
	}

	/**
	 * Specify features to enable.
	 * @see com.fasterxml.jackson.core.JsonParser.Feature
	 * @see com.fasterxml.jackson.core.JsonGenerator.Feature
	 * @see com.fasterxml.jackson.databind.SerializationFeature
	 * @see com.fasterxml.jackson.databind.DeserializationFeature
	 * @see com.fasterxml.jackson.databind.MapperFeature
	 */
	public Jackson2ObjectMapperBuilder featuresToEnable(Object... featuresToEnable) {
<span class="fc bfc" id="L474" title="All 2 branches covered.">		for (Object feature : featuresToEnable) {</span>
<span class="fc" id="L475">			this.features.put(feature, Boolean.TRUE);</span>
		}
<span class="fc" id="L477">		return this;</span>
	}

	/**
	 * Specify features to disable.
	 * @see com.fasterxml.jackson.core.JsonParser.Feature
	 * @see com.fasterxml.jackson.core.JsonGenerator.Feature
	 * @see com.fasterxml.jackson.databind.SerializationFeature
	 * @see com.fasterxml.jackson.databind.DeserializationFeature
	 * @see com.fasterxml.jackson.databind.MapperFeature
	 */
	public Jackson2ObjectMapperBuilder featuresToDisable(Object... featuresToDisable) {
<span class="fc bfc" id="L489" title="All 2 branches covered.">		for (Object feature : featuresToDisable) {</span>
<span class="fc" id="L490">			this.features.put(feature, Boolean.FALSE);</span>
		}
<span class="fc" id="L492">		return this;</span>
	}

	/**
	 * Specify one or more modules to be registered with the {@link ObjectMapper}.
	 * &lt;p&gt;Note: If this is set, no finding of modules is going to happen - not by
	 * Jackson, and not by Spring either (see {@link #findModulesViaServiceLoader}).
	 * As a consequence, specifying an empty list here will suppress any kind of
	 * module detection.
	 * &lt;p&gt;Specify either this or {@link #modulesToInstall}, not both.
	 * @since 4.1.5
	 * @see #modules(List)
	 * @see com.fasterxml.jackson.databind.Module
	 */
	public Jackson2ObjectMapperBuilder modules(Module... modules) {
<span class="fc" id="L507">		return modules(Arrays.asList(modules));</span>
	}

	/**
	 * Set a complete list of modules to be registered with the {@link ObjectMapper}.
	 * &lt;p&gt;Note: If this is set, no finding of modules is going to happen - not by
	 * Jackson, and not by Spring either (see {@link #findModulesViaServiceLoader}).
	 * As a consequence, specifying an empty list here will suppress any kind of
	 * module detection.
	 * &lt;p&gt;Specify either this or {@link #modulesToInstall}, not both.
	 * @see #modules(Module...)
	 * @see com.fasterxml.jackson.databind.Module
	 */
	public Jackson2ObjectMapperBuilder modules(List&lt;Module&gt; modules) {
<span class="fc" id="L521">		this.modules = new LinkedList&lt;&gt;(modules);</span>
<span class="fc" id="L522">		this.findModulesViaServiceLoader = false;</span>
<span class="fc" id="L523">		this.findWellKnownModules = false;</span>
<span class="fc" id="L524">		return this;</span>
	}

	/**
	 * Specify one or more modules to be registered with the {@link ObjectMapper}.
	 * &lt;p&gt;Modules specified here will be registered after
	 * Spring's autodetection of JSR-310 and Joda-Time, or Jackson's
	 * finding of modules (see {@link #findModulesViaServiceLoader}),
	 * allowing to eventually override their configuration.
	 * &lt;p&gt;Specify either this or {@link #modules}, not both.
	 * @since 4.1.5
	 * @see com.fasterxml.jackson.databind.Module
	 */
	public Jackson2ObjectMapperBuilder modulesToInstall(Module... modules) {
<span class="fc" id="L538">		this.modules = Arrays.asList(modules);</span>
<span class="fc" id="L539">		this.findWellKnownModules = true;</span>
<span class="fc" id="L540">		return this;</span>
	}

	/**
	 * Specify one or more modules by class to be registered with
	 * the {@link ObjectMapper}.
	 * &lt;p&gt;Modules specified here will be registered after
	 * Spring's autodetection of JSR-310 and Joda-Time, or Jackson's
	 * finding of modules (see {@link #findModulesViaServiceLoader}),
	 * allowing to eventually override their configuration.
	 * &lt;p&gt;Specify either this or {@link #modules}, not both.
	 * @see #modulesToInstall(Module...)
	 * @see com.fasterxml.jackson.databind.Module
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Jackson2ObjectMapperBuilder modulesToInstall(Class&lt;? extends Module&gt;... modules) {
<span class="fc" id="L556">		this.moduleClasses = modules;</span>
<span class="fc" id="L557">		this.findWellKnownModules = true;</span>
<span class="fc" id="L558">		return this;</span>
	}

	/**
	 * Set whether to let Jackson find available modules via the JDK ServiceLoader,
	 * based on META-INF metadata in the classpath.
	 * &lt;p&gt;If this mode is not set, Spring's Jackson2ObjectMapperBuilder itself
	 * will try to find the JSR-310 and Joda-Time support modules on the classpath -
	 * provided that Java 8 and Joda-Time themselves are available, respectively.
	 * @see com.fasterxml.jackson.databind.ObjectMapper#findModules()
	 */
	public Jackson2ObjectMapperBuilder findModulesViaServiceLoader(boolean findModules) {
<span class="nc" id="L570">		this.findModulesViaServiceLoader = findModules;</span>
<span class="nc" id="L571">		return this;</span>
	}

	/**
	 * Set the ClassLoader to use for loading Jackson extension modules.
	 */
	public Jackson2ObjectMapperBuilder moduleClassLoader(ClassLoader moduleClassLoader) {
<span class="nc" id="L578">		this.moduleClassLoader = moduleClassLoader;</span>
<span class="nc" id="L579">		return this;</span>
	}

	/**
	 * Customize the construction of Jackson handlers ({@link JsonSerializer}, {@link JsonDeserializer},
	 * {@link KeyDeserializer}, {@code TypeResolverBuilder} and {@code TypeIdResolver}).
	 * @since 4.1.3
	 * @see Jackson2ObjectMapperBuilder#applicationContext(ApplicationContext)
	 */
	public Jackson2ObjectMapperBuilder handlerInstantiator(HandlerInstantiator handlerInstantiator) {
<span class="fc" id="L589">		this.handlerInstantiator = handlerInstantiator;</span>
<span class="fc" id="L590">		return this;</span>
	}

	/**
	 * Set the Spring {@link ApplicationContext} in order to autowire Jackson handlers ({@link JsonSerializer},
	 * {@link JsonDeserializer}, {@link KeyDeserializer}, {@code TypeResolverBuilder} and {@code TypeIdResolver}).
	 * @since 4.1.3
	 * @see SpringHandlerInstantiator
	 */
	public Jackson2ObjectMapperBuilder applicationContext(ApplicationContext applicationContext) {
<span class="nc" id="L600">		this.applicationContext = applicationContext;</span>
<span class="nc" id="L601">		return this;</span>
	}


	/**
	 * Build a new {@link ObjectMapper} instance.
	 * &lt;p&gt;Each build operation produces an independent {@link ObjectMapper} instance.
	 * The builder's settings can get modified, with a subsequent build operation
	 * then producing a new {@link ObjectMapper} based on the most recent settings.
	 * @return the newly built ObjectMapper
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public &lt;T extends ObjectMapper&gt; T build() {
		ObjectMapper mapper;
<span class="fc bfc" id="L615" title="All 2 branches covered.">		if (this.createXmlMapper) {</span>
<span class="fc bfc" id="L616" title="All 2 branches covered.">			mapper = (this.defaultUseWrapper != null ?</span>
<span class="fc" id="L617">					new XmlObjectMapperInitializer().create(this.defaultUseWrapper) :</span>
<span class="fc" id="L618">					new XmlObjectMapperInitializer().create());</span>
		}
		else {
<span class="fc bfc" id="L621" title="All 2 branches covered.">			mapper = (this.factory != null ? new ObjectMapper(this.factory) : new ObjectMapper());</span>
		}
<span class="fc" id="L623">		configure(mapper);</span>
<span class="fc" id="L624">		return (T) mapper;</span>
	}

	/**
	 * Configure an existing {@link ObjectMapper} instance with this builder's
	 * settings. This can be applied to any number of {@code ObjectMappers}.
	 * @param objectMapper the ObjectMapper to configure
	 */
	public void configure(ObjectMapper objectMapper) {
<span class="fc" id="L633">		Assert.notNull(objectMapper, &quot;ObjectMapper must not be null&quot;);</span>

<span class="fc" id="L635">		Map&lt;Object, Module&gt; modulesToRegister = new LinkedHashMap&lt;&gt;();</span>
<span class="pc bpc" id="L636" title="1 of 2 branches missed.">		if (this.findModulesViaServiceLoader) {</span>
<span class="nc" id="L637">			ObjectMapper.findModules(this.moduleClassLoader).forEach(module -&gt; modulesToRegister.put(module.getTypeId(), module));</span>
		}
<span class="fc bfc" id="L639" title="All 2 branches covered.">		else if (this.findWellKnownModules) {</span>
<span class="fc" id="L640">			registerWellKnownModulesIfAvailable(modulesToRegister);</span>
		}

<span class="fc bfc" id="L643" title="All 2 branches covered.">		if (this.modules != null) {</span>
<span class="fc" id="L644">			this.modules.forEach(module -&gt; modulesToRegister.put(module.getTypeId(), module));</span>
		}
<span class="fc bfc" id="L646" title="All 2 branches covered.">		if (this.moduleClasses != null) {</span>
<span class="fc bfc" id="L647" title="All 2 branches covered.">			for (Class&lt;? extends Module&gt; moduleClass : this.moduleClasses) {</span>
<span class="fc" id="L648">				Module module = BeanUtils.instantiateClass(moduleClass);</span>
<span class="fc" id="L649">				modulesToRegister.put(module.getTypeId(), module);</span>
			}
		}
<span class="fc" id="L652">		objectMapper.registerModules(modulesToRegister.values());</span>

<span class="fc bfc" id="L654" title="All 2 branches covered.">		if (this.dateFormat != null) {</span>
<span class="fc" id="L655">			objectMapper.setDateFormat(this.dateFormat);</span>
		}
<span class="fc bfc" id="L657" title="All 2 branches covered.">		if (this.locale != null) {</span>
<span class="fc" id="L658">			objectMapper.setLocale(this.locale);</span>
		}
<span class="fc bfc" id="L660" title="All 2 branches covered.">		if (this.timeZone != null) {</span>
<span class="fc" id="L661">			objectMapper.setTimeZone(this.timeZone);</span>
		}

<span class="fc bfc" id="L664" title="All 2 branches covered.">		if (this.annotationIntrospector != null) {</span>
<span class="fc" id="L665">			objectMapper.setAnnotationIntrospector(this.annotationIntrospector);</span>
		}
<span class="fc bfc" id="L667" title="All 2 branches covered.">		if (this.propertyNamingStrategy != null) {</span>
<span class="fc" id="L668">			objectMapper.setPropertyNamingStrategy(this.propertyNamingStrategy);</span>
		}
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">		if (this.defaultTyping != null) {</span>
<span class="nc" id="L671">			objectMapper.setDefaultTyping(this.defaultTyping);</span>
		}
<span class="fc bfc" id="L673" title="All 2 branches covered.">		if (this.serializationInclusion != null) {</span>
<span class="fc" id="L674">			objectMapper.setSerializationInclusion(this.serializationInclusion);</span>
		}

<span class="fc bfc" id="L677" title="All 2 branches covered.">		if (this.filters != null) {</span>
<span class="fc" id="L678">			objectMapper.setFilterProvider(this.filters);</span>
		}

<span class="fc" id="L681">		this.mixIns.forEach(objectMapper::addMixIn);</span>

<span class="fc bfc" id="L683" title="All 4 branches covered.">		if (!this.serializers.isEmpty() || !this.deserializers.isEmpty()) {</span>
<span class="fc" id="L684">			SimpleModule module = new SimpleModule();</span>
<span class="fc" id="L685">			addSerializers(module);</span>
<span class="fc" id="L686">			addDeserializers(module);</span>
<span class="fc" id="L687">			objectMapper.registerModule(module);</span>
		}

<span class="fc" id="L690">		this.visibilities.forEach(objectMapper::setVisibility);</span>

<span class="fc" id="L692">		customizeDefaultFeatures(objectMapper);</span>
<span class="fc" id="L693">		this.features.forEach((feature, enabled) -&gt; configureFeature(objectMapper, feature, enabled));</span>

<span class="fc bfc" id="L695" title="All 2 branches covered.">		if (this.handlerInstantiator != null) {</span>
<span class="fc" id="L696">			objectMapper.setHandlerInstantiator(this.handlerInstantiator);</span>
		}
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">		else if (this.applicationContext != null) {</span>
<span class="nc" id="L699">			objectMapper.setHandlerInstantiator(</span>
<span class="nc" id="L700">					new SpringHandlerInstantiator(this.applicationContext.getAutowireCapableBeanFactory()));</span>
		}
<span class="fc" id="L702">	}</span>


	// Any change to this method should be also applied to spring-jms and spring-messaging
	// MappingJackson2MessageConverter default constructors
	private void customizeDefaultFeatures(ObjectMapper objectMapper) {
<span class="fc bfc" id="L708" title="All 2 branches covered.">		if (!this.features.containsKey(MapperFeature.DEFAULT_VIEW_INCLUSION)) {</span>
<span class="fc" id="L709">			configureFeature(objectMapper, MapperFeature.DEFAULT_VIEW_INCLUSION, false);</span>
		}
<span class="fc bfc" id="L711" title="All 2 branches covered.">		if (!this.features.containsKey(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES)) {</span>
<span class="fc" id="L712">			configureFeature(objectMapper, DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
		}
<span class="fc" id="L714">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	private &lt;T&gt; void addSerializers(SimpleModule module) {
<span class="fc" id="L718">		this.serializers.forEach((type, serializer) -&gt;</span>
<span class="fc" id="L719">				module.addSerializer((Class&lt;? extends T&gt;) type, (JsonSerializer&lt;T&gt;) serializer));</span>
<span class="fc" id="L720">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	private &lt;T&gt; void addDeserializers(SimpleModule module) {
<span class="fc" id="L724">		this.deserializers.forEach((type, deserializer) -&gt;</span>
<span class="fc" id="L725">				module.addDeserializer((Class&lt;T&gt;) type, (JsonDeserializer&lt;? extends T&gt;) deserializer));</span>
<span class="fc" id="L726">	}</span>

	private void configureFeature(ObjectMapper objectMapper, Object feature, boolean enabled) {
<span class="fc bfc" id="L729" title="All 2 branches covered.">		if (feature instanceof JsonParser.Feature) {</span>
<span class="fc" id="L730">			objectMapper.configure((JsonParser.Feature) feature, enabled);</span>
		}
<span class="fc bfc" id="L732" title="All 2 branches covered.">		else if (feature instanceof JsonGenerator.Feature) {</span>
<span class="fc" id="L733">			objectMapper.configure((JsonGenerator.Feature) feature, enabled);</span>
		}
<span class="fc bfc" id="L735" title="All 2 branches covered.">		else if (feature instanceof SerializationFeature) {</span>
<span class="fc" id="L736">			objectMapper.configure((SerializationFeature) feature, enabled);</span>
		}
<span class="fc bfc" id="L738" title="All 2 branches covered.">		else if (feature instanceof DeserializationFeature) {</span>
<span class="fc" id="L739">			objectMapper.configure((DeserializationFeature) feature, enabled);</span>
		}
<span class="fc bfc" id="L741" title="All 2 branches covered.">		else if (feature instanceof MapperFeature) {</span>
<span class="fc" id="L742">			objectMapper.configure((MapperFeature) feature, enabled);</span>
		}
		else {
<span class="fc" id="L745">			throw new FatalBeanException(&quot;Unknown feature class: &quot; + feature.getClass().getName());</span>
		}
<span class="fc" id="L747">	}</span>

	@SuppressWarnings(&quot;unchecked&quot;)
	private void registerWellKnownModulesIfAvailable(Map&lt;Object, Module&gt; modulesToRegister) {
		try {
<span class="fc" id="L752">			Class&lt;? extends Module&gt; jdk8ModuleClass = (Class&lt;? extends Module&gt;)</span>
<span class="fc" id="L753">					ClassUtils.forName(&quot;com.fasterxml.jackson.datatype.jdk8.Jdk8Module&quot;, this.moduleClassLoader);</span>
<span class="fc" id="L754">			Module jdk8Module = BeanUtils.instantiateClass(jdk8ModuleClass);</span>
<span class="fc" id="L755">			modulesToRegister.put(jdk8Module.getTypeId(), jdk8Module);</span>
		}
<span class="nc" id="L757">		catch (ClassNotFoundException ex) {</span>
			// jackson-datatype-jdk8 not available
<span class="fc" id="L759">		}</span>

		try {
<span class="fc" id="L762">			Class&lt;? extends Module&gt; javaTimeModuleClass = (Class&lt;? extends Module&gt;)</span>
<span class="fc" id="L763">					ClassUtils.forName(&quot;com.fasterxml.jackson.datatype.jsr310.JavaTimeModule&quot;, this.moduleClassLoader);</span>
<span class="fc" id="L764">			Module javaTimeModule = BeanUtils.instantiateClass(javaTimeModuleClass);</span>
<span class="fc" id="L765">			modulesToRegister.put(javaTimeModule.getTypeId(), javaTimeModule);</span>
		}
<span class="nc" id="L767">		catch (ClassNotFoundException ex) {</span>
			// jackson-datatype-jsr310 not available
<span class="fc" id="L769">		}</span>

		// Joda-Time present?
<span class="pc bpc" id="L772" title="1 of 2 branches missed.">		if (ClassUtils.isPresent(&quot;org.joda.time.LocalDate&quot;, this.moduleClassLoader)) {</span>
			try {
<span class="fc" id="L774">				Class&lt;? extends Module&gt; jodaModuleClass = (Class&lt;? extends Module&gt;)</span>
<span class="fc" id="L775">						ClassUtils.forName(&quot;com.fasterxml.jackson.datatype.joda.JodaModule&quot;, this.moduleClassLoader);</span>
<span class="fc" id="L776">				Module jodaModule = BeanUtils.instantiateClass(jodaModuleClass);</span>
<span class="fc" id="L777">				modulesToRegister.put(jodaModule.getTypeId(), jodaModule);</span>
			}
<span class="nc" id="L779">			catch (ClassNotFoundException ex) {</span>
				// jackson-datatype-joda not available
<span class="fc" id="L781">			}</span>
		}

		// Kotlin present?
<span class="pc bpc" id="L785" title="1 of 2 branches missed.">		if (KotlinDetector.isKotlinPresent()) {</span>
			try {
<span class="fc" id="L787">				Class&lt;? extends Module&gt; kotlinModuleClass = (Class&lt;? extends Module&gt;)</span>
<span class="fc" id="L788">						ClassUtils.forName(&quot;com.fasterxml.jackson.module.kotlin.KotlinModule&quot;, this.moduleClassLoader);</span>
<span class="fc" id="L789">				Module kotlinModule = BeanUtils.instantiateClass(kotlinModuleClass);</span>
<span class="fc" id="L790">				modulesToRegister.put(kotlinModule.getTypeId(), kotlinModule);</span>
			}
<span class="nc" id="L792">			catch (ClassNotFoundException ex) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">				if (!kotlinWarningLogged) {</span>
<span class="nc" id="L794">					kotlinWarningLogged = true;</span>
<span class="nc" id="L795">					logger.warn(&quot;For Jackson Kotlin classes support please add &quot; +</span>
							&quot;\&quot;com.fasterxml.jackson.module:jackson-module-kotlin\&quot; to the classpath&quot;);
				}
<span class="fc" id="L798">			}</span>
		}
<span class="fc" id="L800">	}</span>


	// Convenience factory methods

	/**
	 * Obtain a {@link Jackson2ObjectMapperBuilder} instance in order to
	 * build a regular JSON {@link ObjectMapper} instance.
	 */
	public static Jackson2ObjectMapperBuilder json() {
<span class="fc" id="L810">		return new Jackson2ObjectMapperBuilder();</span>
	}

	/**
	 * Obtain a {@link Jackson2ObjectMapperBuilder} instance in order to
	 * build an {@link XmlMapper} instance.
	 */
	public static Jackson2ObjectMapperBuilder xml() {
<span class="fc" id="L818">		return new Jackson2ObjectMapperBuilder().createXmlMapper(true);</span>
	}

	/**
	 * Obtain a {@link Jackson2ObjectMapperBuilder} instance in order to
	 * build a Smile data format {@link ObjectMapper} instance.
	 * @since 5.0
	 */
	public static Jackson2ObjectMapperBuilder smile() {
<span class="fc" id="L827">		return new Jackson2ObjectMapperBuilder().factory(new SmileFactoryInitializer().create());</span>
	}

	/**
	 * Obtain a {@link Jackson2ObjectMapperBuilder} instance in order to
	 * build a CBOR data format {@link ObjectMapper} instance.
	 * @since 5.0
	 */
	public static Jackson2ObjectMapperBuilder cbor() {
<span class="fc" id="L836">		return new Jackson2ObjectMapperBuilder().factory(new CborFactoryInitializer().create());</span>
	}


	private static class XmlObjectMapperInitializer {

		public ObjectMapper create() {
<span class="fc" id="L843">			return new XmlMapper(StaxUtils.createDefensiveInputFactory());</span>
		}

		public ObjectMapper create(boolean defaultUseWrapper) {
<span class="fc" id="L847">			JacksonXmlModule module = new JacksonXmlModule();</span>
<span class="fc" id="L848">			module.setDefaultUseWrapper(defaultUseWrapper);</span>
<span class="fc" id="L849">			return new XmlMapper(new XmlFactory(StaxUtils.createDefensiveInputFactory()), module);</span>
		}
	}


	private static class SmileFactoryInitializer {

		public JsonFactory create() {
<span class="fc" id="L857">			return new SmileFactory();</span>
		}
	}


	private static class CborFactoryInitializer {

		public JsonFactory create() {
<span class="fc" id="L865">			return new CBORFactory();</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>